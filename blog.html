<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blog – BandeLab</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    /* ===== Base ===== */
    * { box-sizing: border-box; }

    :root{
      --ink:#2f2d2b;
      --paper:#f7f3ee;
      --accent:#d64b2c;
      --ink-2:#1b1b1b;
    }

    body{
      font-family:'IBM Plex Mono',monospace;
      margin:0; color:var(--ink); line-height:1.8; font-size:1rem;
      background:var(--paper); position:relative; z-index:0;
    }
    @media (min-width:768px){ body{ zoom:75%; } }

    body::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image:url('https://www.transparenttextures.com/patterns/paper-fibers.png');
      background-repeat:repeat; opacity:.12;
    }

    header{
      background:var(--paper); color:var(--ink-2);
      padding:.6rem 1.2rem; text-align:center;
      border-bottom:5px solid #1b210d; max-width:1100px; margin:auto;
    }
    header h1{ margin:0; font-size:2.5rem; }
    nav{ margin-top:1rem; }
    nav a{
      color:#333; margin:0 1.2rem; text-decoration:none; font-weight:500; font-size:1.1rem;
      transition:color .2s ease;
    }
    nav a:hover, nav a:focus{ color:var(--accent); text-decoration:none; }

    main{ padding:4rem 1rem; max-width:1100px; margin:auto; }
    h1{ font-size:2rem; margin:0 0 1.2rem; text-align:center; }

    /* ===== Toolbar ===== */
    .toolbar{
      display:grid; grid-template-columns:1fr auto; gap:.8rem; margin:1rem auto 2rem; align-items:center;
    }
    .search,.sort{
      display:flex; gap:.6rem; align-items:center; background:#fff;
      border:2px solid var(--ink); border-radius:999px; padding:.4rem .8rem;
    }
    .search input,.sort select{ border:none; outline:none; background:transparent; font:inherit; }

    /* ===== Entries grid ===== */
    .blog-grid{
      display:grid; grid-template-columns:1fr; gap:1.6rem;
    }

    /* ===== Card (image LEFT + meta RIGHT inside the card) ===== */
    .card{
      background:var(--paper);
      border:2px solid var(--ink);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 8px 16px rgba(0,0,0,.07);
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .card:hover{ transform:translateY(-2px); box-shadow:0 12px 22px rgba(0,0,0,.12); }

    .card-inner{
      display:grid;
      grid-template-columns: clamp(320px, 46%, 560px) minmax(0,1fr);
      gap:1rem;
      padding:1rem;
      align-items:start;
    }

    /* Right (meta) */
    .meta{
      display:flex; flex-direction:column; gap:.75rem;
    }
    .meta h3{ margin:0; font-size:1.05rem; line-height:1.4; }

    .props{
      display:grid; grid-template-columns:auto 1fr; gap:.2rem .6rem; font-size:.9rem; align-items:start;
    }
    .props .label{ font-weight:700; color:var(--ink-2); }
    .props .value{ color:#444; min-width:0; }

    /* Make keywords wrap sooner -> taller card, fewer per row */
    .value.tags{
      display:flex; flex-wrap:wrap; gap:.35rem; padding-top:.1rem;
      inline-size: clamp(24ch, 65%, 36ch);
      align-self:start;
    }
    .tag{
      border:1px solid var(--ink); border-radius:999px; padding:.15rem .6rem;
      background:#fff; font-size:.78rem; line-height:1.2;
    }

    .actions{ margin-top:auto; display:flex; gap:.6rem; justify-content:flex-end; }
    .btn{
      display:inline-flex; align-items:center; gap:.4rem;
      border:2px solid var(--ink); border-radius:10px; padding:.35rem .7rem;
      background:#fff; color:var(--ink); text-decoration:none; font-weight:600; cursor:pointer;
      transition:background .2s,color .2s,transform .08s;
    }
    .btn:hover{ background:var(--ink); color:#fff; }
    .btn.primary{ background:var(--accent); border-color:var(--ink); color:#fff; }
    .btn.primary:hover{ filter:brightness(.96); }

    /* Left (image box) — framed, does NOT touch card border */
    .thumb-box{
      background:#fff;
      border:2px solid var(--ink);
      border-radius:14px;
      padding:10px;
      box-shadow:0 8px 16px rgba(0,0,0,.07);
      display:grid; place-items:center;
      transition:transform .2s ease, box-shadow .2s ease;
      position: relative; /* for Read pill */
    }
    .card:hover .thumb-box{ transform:translateY(-1px); box-shadow:0 12px 22px rgba(0,0,0,.12); }

    .thumb-box img{
      width:100%; height:auto; display:block; border-radius:10px; object-fit:cover;
      aspect-ratio: 4 / 3;
    }

    /* Floating "Read" pill on the image */
    .read-fab{
      position: absolute;
      right: 12px;
      bottom: 12px;
      border: 2px solid var(--ink);
      border-radius: 999px;
      padding: .45rem .9rem;
      background: var(--accent);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,.15);
      transition: transform .08s ease, filter .2s ease;
    }
    .read-fab:hover{ filter:brightness(.96); }
    .read-fab:active{ transform: translateY(1px); }

    /* Stack on small screens (image first, meta next) */
    @media (max-width:700px){
      .card-inner{ grid-template-columns:1fr; }
      .value.tags{ inline-size: clamp(22ch, 85%, 30ch); }
    }

    /* ===== Skeletons (used while loading) ===== */
    .skeleton{
      border:2px solid var(--ink); border-radius:16px; overflow:hidden; background:#eee; position:relative;
      min-height:220px;
    }
    .skeleton .sk-img{ height:160px; background:#e5e5e5; }
    .skeleton .sk-line{ height:14px; background:#e9e9e9; margin:12px; border-radius:8px; }
    .shine{
      position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);
      animation:shine 1.2s infinite;
    }
    @keyframes shine{ 100%{ transform:translateX(100%); } }

    /* ===== Modal Reader ===== */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:1rem; z-index:50;
    }
    .modal.open{ display:flex; }
    .modal-card{
      width:min(100%,960px); max-height:86vh; overflow:auto;
      background:var(--paper); border:2px solid var(--ink); border-radius:16px;
      box-shadow:0 12px 24px rgba(0,0,0,.25);
    }
    .modal-head{
      position:sticky; top:0; background:var(--paper); z-index:2;
      border-bottom:2px solid var(--ink); padding:.8rem 1rem;
      display:flex; align-items:center; gap:.8rem; justify-content:space-between;
    }
    .modal-title{ margin:0; font-size:1.2rem; }
    .modal-sub{ color:#555; font-size:.9rem; }
    .modal-body{ padding:1rem 1.2rem 1.3rem; line-height:1.9; color:#2b2a28; }
    .modal-body p{ margin:.6rem 0; }
    .close-x{
      border:2px solid var(--ink); background:#fff; color:#2f2d2b; border-radius:8px; padding:.25rem .5rem; cursor:pointer; font-weight:700;
    }
    .modal-actions{ display:flex; gap:.6rem; align-items:center; }

/* ===== Footer (compact, single-line) ===== */
footer{
  background:#2f2d2b; color:#f2e9de;
  border-top:8px solid #f2e9de;
  font-family:monospace;
}
footer .footer-inner{
  max-width:1100px; margin:0 auto;
  padding:.6rem 1rem;              /* compact height */
  display:flex; align-items:center; justify-content:center;
  gap:.6rem; line-height:1; text-align:center;
}
.footer-logo{
  background:#f2e9de; color:#2f2d2b; border-radius:50%;
  width:28px; height:28px;          /* smaller circle */
  display:flex; justify-content:center; align-items:center;
  font-weight:bold; font-size:.85rem; flex:0 0 auto;
  margin:0;                         /* remove previous bottom margin */
}

    /* Motion safety */
    @media (prefers-reduced-motion:reduce){
      *{ animation:none!important; transition:none!important; }
    }
  </style>
</head>
<body>
  <header>
    <h1>BandeLab</h1>
    <nav>
      <a href="index.html">About</a>
      <a href="youtube.html">YouTube</a>
      <a href="berry.html">Mobile Application (Berry)</a>
      <a href="blog.html" aria-current="page">Blog</a>
    </nav>
  </header>

  <main>
    <h1>Blog</h1>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#2f2d2b" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="searchInput" type="search" placeholder="Search title or keywords…" aria-label="Search blog posts"/>
      </div>
      <div class="sort">
        <label for="sortSelect">Sort:</label>
        <select id="sortSelect" aria-label="Sort posts">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="title">Title (A–Z)</option>
        </select>
      </div>
    </div>

    <!-- Entries list -->
    <div id="grid" class="blog-grid" aria-live="polite">
      <!-- Skeletons while loading -->
      <div class="skeleton">
        <div class="sk-img"></div><div class="shine"></div>
        <div class="sk-line" style="width:70%"></div>
        <div class="sk-line" style="width:50%"></div>
        <div class="sk-line" style="width:85%"></div>
      </div>
      <div class="skeleton">
        <div class="sk-img"></div><div class="shine"></div>
        <div class="sk-line" style="width:65%"></div>
        <div class="sk-line" style="width:55%"></div>
        <div class="sk-line" style="width:80%"></div>
      </div>
      <div class="skeleton">
        <div class="sk-img"></div><div class="shine"></div>
        <div class="sk-line" style="width:60%"></div>
        <div class="sk-line" style="width:58%"></div>
        <div class="sk-line" style="width:70%"></div>
      </div>
    </div>
  </main>


  <!-- Reader Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <h3 id="modalTitle" class="modal-title">Loading…</h3>
          <div id="modalMeta" class="modal-sub"></div>
        </div>
        <div class="modal-actions">
          <button class="close-x" id="closeModal" aria-label="Close">✕</button>
        </div>
      </div>
      <div id="modalBody" class="modal-body">Please wait…</div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const ALL_BLOGS_PATH = 'all_blogs.txt'; // same directory as this HTML
    const PICS_DIR = 'blog_pics';           // images folder
    const BLOGS_DIR = 'blogs';              // text files folder

    // ========= UTILITIES =========
    const byId = (id) => document.getElementById(id);

    function parseDateDDMMYYYY(s){
      const m = s.trim().match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
      if(!m) return null;
      const [_, d, mo, y] = m;
      return new Date(Number(y), Number(mo)-1, Number(d));
    }
    function formatDatePretty(d){
      if(!(d instanceof Date) || isNaN(d)) return '';
      return d.toLocaleDateString(undefined, { day:'2-digit', month:'short', year:'numeric' });
    }
    function slugify(s){
      return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }

    // Robust splitter: supports `--`, `—`, `–` lines as separators
    function splitBlocks(text){
      return text.split(/\n\s*(?:-{2,}|—+|–+)\s*\n/);
    }

    function getField(block, names){
      for(const name of names){
        const rx = new RegExp('^\\s*' + name + '\\s*:\\s*(.+)$','im');
        const m = block.match(rx);
        if(m) return m[1].trim();
      }
      return '';
    }

    function parseAllBlogs(text){
      const blocks = splitBlocks(text).map(b => b.trim()).filter(Boolean);
      const items = [];
      for(const b of blocks){
        const title = getField(b, ['Blog\\s*title','Blog\\s*tile','Title']);
        const ts    = getField(b, ['Time\\s*stamp','Timestamp','Date']);
        const pic   = getField(b, ['Picture\\s*name','Picture','Image']);
        const file  = getField(b, ['Blog\\s*file\\s*name','File','Post']);
        const kwStr = getField(b, ['Keywords?']);
        const keywords = kwStr ? kwStr.split(/[,;]+/).map(k=>k.trim()).filter(Boolean) : [];
        const dateObj = ts ? (parseDateDDMMYYYY(ts) || new Date(ts)) : null;

        if(title && file){
          items.push({
            id: slugify(file.replace(/\.\w+$/,'')) || slugify(title),
            title, ts, date: dateObj, pic, file, keywords
          });
        }
      }
      return items;
    }

    // ========= RENDERING =========
    const grid = byId('grid');
    const searchInput = byId('searchInput');
    const sortSelect = byId('sortSelect');

    let ALL_ITEMS = [];

    function matchesFilters(item){
      const q = (searchInput.value || '').trim().toLowerCase();
      if(q){
        const inTitle = item.title.toLowerCase().includes(q);
        const inKw = item.keywords.some(k => k.toLowerCase().includes(q));
        if(!inTitle && !inKw) return false;
      }
      return true;
    }

    function sortItems(items){
      const mode = sortSelect.value;
      const copy = items.slice();
      if(mode === 'newest'){
        copy.sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
      }else if(mode === 'oldest'){
        copy.sort((a,b) => (a.date?.getTime()||0) - (b.date?.getTime()||0));
      }else if(mode === 'title'){
        copy.sort((a,b) => a.title.localeCompare(b.title));
      }
      return copy;
    }

    function renderCards(){
      const filtered = ALL_ITEMS.filter(matchesFilters);
      const sorted = sortItems(filtered);

      if(!sorted.length){
        grid.innerHTML = `
          <div class="card" style="padding:1.2rem">
            <h3 style="margin:0">No posts found</h3>
            <p>Try clearing search.</p>
          </div>`;
        return;
      }

      grid.innerHTML = '';
      sorted.forEach(it => {
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('role','article');
        card.setAttribute('aria-label', it.title);
        card.tabIndex = 0;

        const inner = document.createElement('div');
        inner.className = 'card-inner';

        // LEFT: image panel (with floating Read button)
        const panel = document.createElement('figure');
        panel.className = 'thumb-box';
        panel.setAttribute('aria-hidden','false');

        const img = document.createElement('img');
        img.alt = it.title;
        img.loading = 'lazy';
        img.src = `${PICS_DIR}/${it.pic || 'placeholder.jpg'}`;
        img.onerror = () => { img.src = `${PICS_DIR}/placeholder.jpg`; };
        panel.appendChild(img);

        const readBtn = document.createElement('button');
        readBtn.className = 'read-fab';
        readBtn.textContent = 'Read';
        readBtn.addEventListener('click', (e) => { e.stopPropagation(); openReader(it); });
        panel.appendChild(readBtn);

        // RIGHT: meta
        const meta = document.createElement('div');
        meta.className = 'meta';

        const h = document.createElement('h3');
        h.textContent = it.title;
        meta.appendChild(h);

        const props = document.createElement('div');
        props.className = 'props';

        // Date
        const dateLabel = document.createElement('div');
        dateLabel.className = 'label';
        dateLabel.textContent = 'Date:';
        const dateValue = document.createElement('div');
        dateValue.className = 'value';
        dateValue.textContent = formatDatePretty(it.date) || (it.ts || '');

        // Keywords (per-card tags stay)
        const kwLabel = document.createElement('div');
        kwLabel.className = 'label';
        kwLabel.textContent = 'Keywords:';
        const kwValue = document.createElement('div');
        kwValue.className = 'value tags';
        if(it.keywords.length){
          it.keywords.forEach(k => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = k;
            kwValue.appendChild(tag);
          });
        } else {
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = '—';
          kwValue.appendChild(tag);
        }

        props.append(dateLabel, dateValue, kwLabel, kwValue);
        meta.appendChild(props);

        // open reader
        card.addEventListener('click', () => openReader(it));
        panel.addEventListener('click', (e) => { e.stopPropagation(); openReader(it); });
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openReader(it); }
        });

        inner.append(panel, meta);
        card.appendChild(inner);
        grid.appendChild(card);
      });
    }

    // ========= Reader =========
    const modal      = byId('modal');
    const modalTitle = byId('modalTitle');
    const modalMeta  = byId('modalMeta');
    const modalBody  = byId('modalBody');
    const closeModalBtn = byId('closeModal');

    function readingTime(text){
      const words = (text||'').trim().split(/\s+/).filter(Boolean).length;
      const minutes = Math.max(1, Math.round(words / 220));
      return `${minutes} min read`;
    }

    function toParagraphs(text){
      return text.split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g,'<br/>')}</p>`).join('\n');
    }

    async function openReader(item){
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      modalTitle.textContent = item.title;
      modalMeta.textContent = formatDatePretty(item.date) || (item.ts || '');
      modalBody.innerHTML = 'Loading…';

      const url = new URL(window.location.href);
      url.searchParams.set('post', item.id);
      history.replaceState(null, '', url.toString());

      try{
        const res = await fetch(`${BLOGS_DIR}/${item.file}`, { cache:'no-store' });
        if(!res.ok) throw new Error('Not found');
        const txt = await res.text();
        modalMeta.textContent = `${modalMeta.textContent}  •  ${readingTime(txt)}`;
        modalBody.innerHTML = toParagraphs(txt);
      }catch(e){
        modalBody.innerHTML = `<p>Could not load this blog file.</p>`;
      }
    }

    function closeReader(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      const url = new URL(window.location.href);
      url.searchParams.delete('post');
      history.replaceState(null, '', url.toString());
    }

    closeModalBtn.addEventListener('click', closeReader);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeReader(); });
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape' && modal.classList.contains('open')) closeReader(); });

    // ========= Bootstrap =========
    async function loadAll(){
      try{
        const res = await fetch(ALL_BLOGS_PATH, { cache:'no-store' });
        if(!res.ok) throw new Error('Cannot read all_blogs.txt');
        const raw = await res.text();
        ALL_ITEMS = parseAllBlogs(raw);
        ALL_ITEMS.sort((a,b) => (b.date?.getTime()||0) - (a.date?.getTime()||0));
        renderCards();

        // Deep-link ?post=slug
        const params = new URLSearchParams(window.location.search);
        const slug = params.get('post');
        if(slug){
          const found = ALL_ITEMS.find(x =>
            x.id === slug ||
            slugify(x.title) === slug ||
            slugify(x.file.replace(/\.\w+$/,'')) === slug
          );
          if(found) openReader(found);
        }
      }catch(e){
        grid.innerHTML = `<div class="card" style="padding:1.2rem"><h3 style="margin:0">Blogs not available</h3><p>Make sure <code>${ALL_BLOGS_PATH}</code> is deployed next to this page.</p></div>`;
      }
    }

    searchInput.addEventListener('input', renderCards);
    sortSelect.addEventListener('change', renderCards);
    loadAll();
  </script>
</body>
</html>
